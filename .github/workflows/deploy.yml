name: Deploy to GitHub Pages

on:
  push:
    branches: [main, master, claude/godot-rewrite-6qMSr]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.2.2

    steps:
      - uses: actions/checkout@v4

      - name: Setup export templates
        run: |
          mkdir -p ~/.local/share/godot/export_templates/4.2.2.stable
          find /root -name "*.tpz" -o -name "web_*" 2>/dev/null || true
          find /root -type d -name "templates" 2>/dev/null || true
          ls -la /root/.local/share/godot/ || true
          if [ -d "/root/.local/share/godot/templates/4.2.2.stable" ]; then
            cp -r /root/.local/share/godot/templates/4.2.2.stable/* ~/.local/share/godot/export_templates/4.2.2.stable/
          elif [ -d "/root/.local/share/godot/export_templates/4.2.2.stable" ]; then
            echo "Templates already in place"
          else
            echo "Searching for templates..."
            find /root -name "web_template*" 2>/dev/null
          fi

      - name: Build Web Export
        run: |
          mkdir -p godot_version/build/web
          cd godot_version
          /usr/local/bin/godot --headless --export-release "Web" build/web/index.html

      - name: Add coi-serviceworker for SharedArrayBuffer
        run: |
          cd godot_version/build/web
          wget -q https://cdn.jsdelivr.net/npm/coi-serviceworker@0.1.7/coi-serviceworker.min.js -O coi-sw.js
          sed -i 's|<head>|<head><script src="coi-sw.js"></script>|' index.html
          touch .nojekyll

      - name: Deploy to gh-pages
        run: |
          cd godot_version/build/web
          git init
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Deploy Cannon Defence"
          git push --force https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:gh-pages
